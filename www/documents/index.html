<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Complete Discography | dlove.it</title>

  <!-- Display the same in all browsers.  Must be first stylesheet. -->
  <link href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.css" rel="stylesheet" type="text/css" />
  <link href="lib/bootswatch/css/bootswatch-solar.min.css" rel="stylesheet" type="text/css" />
  <link href="lib/sortable-0.8.0/css/sortable-theme-bootstrap.css" rel="stylesheet" type="text/css" />
  <link href="css/style.css" rel="stylesheet" type="text/css" />

  <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script> 
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
  <script type="text/javascript" src="lib/stupidtable/js/stupidtable.js"></script> 
  <script>
    const SUBMIT_BTN_INIT_TEXT = "Go!"
    const SUBMIT_BTN_LOADING_TEXT = "Loading..."
    var artist
    socket = io("wss://"+window.location.hostname+"/discography", options={"transports":["websocket"]})
    socket.on("release_rows", function(data) {
      console.log("release_rows")
      init_disco(true)
      $("#disco").append(data)
      resort()
    })

    socket.on("complete", function() {
      console.log("complete")
      $("#loading").hide()
      init_disco(false) // cover the case of 0 rows
    })

    $(function () {
      $("#artist").on('input', correctButtonEnablement)
      correctButtonEnablement()
      $("#disco-table").stupidtable()
    })

    function correctButtonEnablement() {
      $("#submit").prop('disabled', $("#artist").val().length == 0)
    }

    function get_discography(e) {
      e.preventDefault()
      artist = $("#artist").val()
      let btnText = $("#submit").html()
      $("#submit").html(SUBMIT_BTN_LOADING_TEXT)
      $("#submit").prop('disabled', true)
      $("#artist-container").hide()
      $("#disco-container").hide()
      $("#disco").empty()
      $("#loading").show()
      console.log("socket emit get '"+artist+"'")
      socket.emit("get", artist)
      return false;
    }

    /*
     * Initialize the discography display area
     *
     * results_found: boolean indicating if results were found
    */
    function init_disco(results_found) {
      if ($("#submit").prop('disabled') == false) {
        return false
      }
      if (results_found) {
        $("#results-heading").html("Complete Discography for "+artist)
        $("#disco-table").show()
      } else {
        $("#results-heading").html("No results found.")
        $("#disco-table").hide()
      }
      $("#submit").html(SUBMIT_BTN_INIT_TEXT)
      $("#submit").prop('disabled', false)
      $("#disco-container").show()
    }

    /*
     * Force Sortable library to sort the table again by the selected column
     */
    function resort() {
      $("#disco-head tr").children().each(function () {
        if ($(this).hasClass("sorting-asc")) {
          $(this).stupidsort("asc");
        } else if ($(this).hasClass("sorting-desc")) {
          $(this).stupidsort("desc");
        }
      })
    }  
  </script>
</head>
<body>
  <main class="center-contents">
    <div class="spacey">
      <h1 class="text-primary">Complete Discography</h1>
      <div class="little-spacey">
        <p>If you follow an artist who performs in several different bands, this tool is for you. 
          Enter their name to get a list of every album they've released under all of their various bands and aliases.</p>
        <p>This app uses Python and Flask to retrieve data from <a href="https://discogs.com">Discogs</a> 
          via their handy <a href="https://www.discogs.com/developers">API</a>.  
          Check out the source code on <a href="https://github.com/dfunklove/complete-discography">GitHub</a>.</p>
      </div>
      <form class="bs-component" onsubmit="get_discography(event)">
        <div class="form-group">
          <label for="artist" class="col-form-label-lg">Artist Name</label><br>
          <input class="form-control-lg center-contents" id="artist">
        </div>
      </form>
      <button class="btn btn-primary btn-lg" id="submit" disabled="true" onclick="get_discography(event)">Go!</button>
    </div>
    <div id="artist-container" class="hidden spacey">
      <h2>Please choose your artist.</h2>
      <div id="artist-list" class="center-me limit-width"></div>
    </div>
    <div id="disco-container" class="hidden spacey jumbotron-background">
      <div class="center-me center-contents">
        <h2 id="results-heading" class="text-success">Results</h2>
        <table id="disco-table" class="center-me little-spacey sortable" data-sortable>
          <thead id="disco-head">
            <tr>
              <th>&nbsp;</th>
              <th id="artist-column" data-sort="string-ins" data-sort-multicolumn="title-column">Artist</th>
              <th id="title-column" data-sort="string-ins" data-sort-multicolumn="label-column">Title</th>
              <th id="label-column" data-sort="string-ins" data-sort-multicolumn="title-column">Label</th>
              <th id="year-column" data-sort="int" data-sort-multicolumn="title-column">Year</th>
            </tr>
          </thead>
          <tbody id="disco"></tbody>
        </table>
      </div>
    </div>
    <div id="loading" class="hidden">
      <img src="images/spinner.svg"/>
    </div>
    <div class="big-bottom"></div>
  </main>
</html>