<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Complete Discography | dlove.it</title>

  <!-- Display the same in all browsers.  Must be first stylesheet. -->
  <link href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.css" rel="stylesheet" type="text/css" />
  <link href="style/lib/bootstrap.min.css" rel="stylesheet" type="text/css" />
  <link href="style/style.css" rel="stylesheet" type="text/css" />

  <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script> 
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/socket.io-client@2/dist/socket.io.js"></script>
  <script>
    const SUBMIT_BTN_INIT_TEXT = "Go!"
    const SUBMIT_BTN_LOADING_TEXT = "Loading..."
    socket = io(window.location.protocol+"//"+window.location.hostname+":5000/discography")
    socket.on("release_rows", function(data) {
      console.log("release_rows")
      init_disco(true)
      $("#disco").append(data)
    })

    socket.on("empty_result", function() {
      console.log("empty_result")
      init_disco(false)
    })

    $(function () {
      $("#artist").on('input', function() {
        if ($("#artist").val().length > 0 && $("#submit").prop('disabled')) {
          $("#submit").prop('disabled', false)
        } else if ($("#artist").val().length === 0) {
          $("#submit").prop('disabled', true)
        }
      })
    })

    function get_artists(e) {
      e.preventDefault()
      let uri = encodeURI("/app/artists/"+$("#artist").val())
      console.log("uri="+uri)
      let btnText = $("#submit").html()
      $("#submit").html(SUBMIT_BTN_LOADING_TEXT)
      $("#submit").prop('disabled', true)
      $("#artist-container").hide()
      $("#disco-container").hide()
      $("#loading").show()
      $("#artist-list").load(uri, function() {
        $(".artist_link").each(function() { 
          $(this).click(function() { get_discography($(this).attr("artist_id"), $(this).attr("artist_name")) } ) 
        })
        $("#submit").html(btnText)
        $("#artist-container").show()
        $("#loading").hide()
      })
    }

    function get_discography(e) {
      let name = $("#artist").val()
      let btnText = $("#submit").html()
      $("#submit").html(SUBMIT_BTN_LOADING_TEXT)
      $("#submit").prop('disabled', true)
      $("#artist-container").hide()
      $("#disco-container").hide()
      $("#disco").empty()
      $("#loading").show()
      console.log("socket emit get '"+name+"'")
      socket.emit("get", name)
    }

    /*
     * with_results: boolean indicating if results were found
    */
    function init_disco(results_found) {
      if ($("#submit").prop('disabled') == false) {
        return false
      }
      if (results_found) {
        $("#results-heading").html("Complete Discography for "+$("#artist").val())
      } else {
        $("#results-heading").html("No results found.")
      }
      $("#stats").addClass("center-me big-bottom")
      $("#stats-heading").addClass("h3 big-bottom")
      $("#releases-heading").addClass("h3 big-bottom")
      $("#submit").html(SUBMIT_BTN_INIT_TEXT)
      $("#submit").prop('disabled', false)
      $("#disco-container").show()
      $("#loading").hide()
    }
  </script>
</head>
<body>
  <main class="center-contents">
    <div class="spacey">
      <h1 class="text-primary">Complete Discography</h1>
      <div class="little-spacey">
        <p>If you follow an artist who performs in several different bands, this tool is for you. 
          Enter their name to get a list of every album they've released under all of their various bands and aliases.</p>
        <p>This app uses Python and Flask to retrieve data from <a href="https://discogs.com">Discogs</a> 
          via their handy <a href="https://www.discogs.com/developers">API</a>.  
          Check out the source code on <a href="https://github.com/dfunklove/complete-discography">GitHub</a>.</p>
      </div>
      <form class="bs-component" onsubmit="get_discography(event)">
        <div class="form-group">
          <label for="artist" class="col-form-label-lg">Artist Name</label><br>
          <input class="form-control-lg center-contents" id="artist">
        </div>
      </form>
      <button class="btn btn-primary btn-lg" id="submit" disabled="true" onclick="get_discography(event)">Go!</button>
    </div>
    <div id="artist-container" class="hidden spacey">
      <h2>Please choose your artist.</h2>
      <div id="artist-list" class="center-me limit-width"></div>
    </div>
    <div id="disco-container" class="hidden spacey big-bottom">
      <div class="center-me center-contents jumbotron-background">
        <h2 id="results-heading" class="text-success">Results</h2>
        <table id="disco" class="center-me little-spacey"></table>
      </div>
    </div>
    <div id="loading" class="hidden spacey">
      <img src="images/spinner.svg"/>
    </div>
  </main>
</html>